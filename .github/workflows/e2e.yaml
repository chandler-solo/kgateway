name: Kubernetes Tests
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  merge_group:
    types: [checks_requested]

env:
  VERSION: '1.0.0-ci1'
  GITHUB_TOKEN: ${{ github.token }}
  GO_TEST_RETRIES: 2
  IMAGE_REGISTRY: ghcr.io/${{ github.repository_owner }}
  ENVOYINIT_CACHE_REF: ghcr.io/${{ github.repository_owner }}/envoy-wrapper-cache

permissions:
  contents: read
  packages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  build-images:
    name: Build Images
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    if: ${{ !github.event.pull_request.draft }}
    steps:
    - uses: actions/checkout@v4
    - name: Prep Go Runner
      uses: ./.github/actions/prep-go-runner

    - uses: docker/setup-buildx-action@v3

    - name: Log into ghcr.io
      uses: docker/login-action@v3
      with:
        registry: ${{ env.IMAGE_REGISTRY }}
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build images with registry cache
      run: make docker-images

    - name: Build dummy-idp
      run: make dummy-idp-docker

    - name: Save images to tar files
      run: |
        make save-images
        # Also save dummy-idp
        docker save ghcr.io/kgateway-dev/dummy-idp:0.0.1 -o _output/images/dummy-idp.tar

    - name: Upload image artifacts
      uses: actions/upload-artifact@v4
      with:
        name: docker-images-amd64
        path: _output/images/
        retention-days: 1

  end_to_end_tests:
    name: End-to-End (${{ matrix.test.cluster-name }})
    needs: build-images
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    if: ${{ !github.event.pull_request.draft }}
    strategy:
      fail-fast: false
      matrix:
        # We intentionally set an upper threshold of 30 minutes for our End-to-End tests
        # Our goal is to load balance tests in a way that allows quick iteration on PRs
        # If tests are exceeding the 30-minute limit, please see:
        # /test/e2e/load_balancing_tests.md
        #
        # Above each test below, we document the latest date/time for the GitHub action step `Run /./.github/actions/kubernetes-e2e-tests` to run
        # NOTE: We use the GitHub action step time (as opposed to the `go test` time or the GitHub action job time), because it is easier to capture and fairly consistent
        test:
        # December 4, 2025: ~24 minutes
        - cluster-name: 'cluster-one'
          go-test-args: '-timeout=25m'
          go-test-run-regex: '^TestKgateway$$/^BasicRouting$$|^TestKgateway$$/^PathMatching$$|^TestKgateway$$/^HTTPRouteServices$$|^TestKgateway$$/^TLSRouteServices$$|^TestKgateway$$/^GRPCRouteServices$$|^TestKgateway$$/^SessionPersistence$$'
          localstack: 'false'
        # December 4, 2025: ~23 minutes
        - cluster-name: 'cluster-two'
          go-test-args: '-timeout=25m'
          go-test-run-regex: '^TestKgatewayWaypoint$$'
          localstack: 'false'
        # December 4, 2025: ~22 minutes
        - cluster-name: 'cluster-three'
          go-test-args: '-timeout=25m'
          go-test-run-regex: '^TestKgateway$$/^DynamicForwardProxy$$|^TestKgateway$$/^Lambda$$|^TestKgateway$$/^AccessLog$$|^TestKgateway$$/^LocalRateLimit$$|^TestKgateway$$/^Cors$$|^TestKgateway$$/^BackendConfigPolicy$$|^TestKgateway$$/^ListenerPolicy$$|^TestKgateway$$/^Tracing$$|^TestKgateway$$/^DirectResponse$$|^TestKgateway$$/^AdminServer$$'
          localstack: 'true'
        # December 4, 2025: ~19 minutes
        - cluster-name: 'cluster-four'
          go-test-args: '-timeout=25m'
          go-test-run-regex: '^TestKgateway$$/^ExtProc$$|^TestKgateway$$/^ExtAuth$$|^TestKgateway$$/^PolicySelector$$|^TestKgateway$$/^Backends$$|^TestKgateway$$/^BackendTLSPolicies$$|^TestKgateway$$/^CSRF$$|^TestKgateway$$/^AutoHostRewrite$$|^TestKgateway$$/^LeaderElection$$|^TestKgateway$$/^Compression$$|^TestParallelControllers$$|^TestCustomGWP$$'
          localstack: 'false'
        # December 4, 2025: ~21 minutes
        - cluster-name: 'cluster-five'
          go-test-args: '-timeout=25m'
          go-test-run-regex: '^TestKgateway$$/^TimeoutRetry$$|^TestKgateway$$/^HeaderModifiers$$|^TestKgateway$$/^RBAC$$|^TestKgateway$$/^APIKeyAuth$$|^TestKgateway$$/^Deployer$$|^TestKgateway$$/^Transforms$$|^TestRouteReplacement$$|^TestKgateway$$/^RouteDelegation$$|^TestKgateway$$/^JWT$$|^TestKgateway$$/^BasicAuth$$'
          localstack: 'false'
        # December 4, 2025: ~22 minutes
        - cluster-name: 'cluster-six'
          go-test-args: '-timeout=25m'
          go-test-run-regex: '^TestListenerSet$$|^TestKgateway$$/^TCPRouteServices$$|^TestKgatewayIstioAutoMtls$$|^TestZeroDowntimeRollout$$'
          localstack: 'false'
        # December 4, 2025: ~9 minutes
        - cluster-name: 'api-validation' # TODO: rename to cluster-seven
          go-test-args: '-timeout=15m'
          go-test-run-regex: '^TestAPIValidation$$|^TestKgateway$$/^OAuth$$'
          localstack: 'false'
        # December 4, 2025: ~15 minutes
        - cluster-name: 'cluster-metrics'
          go-test-args: '-timeout=25m'
          go-test-run-regex: '^TestKgatewayMetrics$$|^TestControlPlaneTLS$$|^TestKgateway$$/^FrontendTLS$$'
          localstack: 'false'
        # December 4, 2025: ~13 minutes
        - cluster-name: 'cluster-multi-install'
          go-test-args: '-timeout=5m'
          go-test-run-regex: '^TestMultipleInstalls'
          localstack: 'false'
        # December 4, 2025: ~17 minutes
        - cluster-name: 'agent-gateway-cluster'
          go-test-args: '-timeout=25m'
          go-test-run-regex: '^TestAgentgatewayIntegration$$|^TestZeroDowntimeRolloutAgentgateway$$'
          agentgateway: 'true'

        # In our PR tests, we run the suite of tests using the upper ends of versions that we claim to support
        # The versions should mirror: https://kgateway.dev/docs/reference/versions/
        version-files:
          - file: './.github/workflows/.env/pr-tests/versions.env'
    steps:
    - uses: actions/checkout@v4
    - name: Prep Go Runner
      uses: ./.github/actions/prep-go-runner
    # The dotenv action is used to load key-value pairs from files.
    # In this case, the file is specified in the matrix and will contain the versions of the tools to use
    - name: Dotenv Action
      uses: falti/dotenv-action@v1.1.4
      id: dotenv
      with:
        path: ${{ matrix.version-files.file }}
        log-variables: true
    - name: Download image artifacts
      uses: actions/download-artifact@v4
      with:
        name: docker-images-amd64
        path: _output/images/
    - name: Load images into Docker
      run: |
        make load-images
        docker load -i _output/images/dummy-idp.tar
    - id: setup-kind-cluster
      name: Setup KinD Cluster
      uses: ./.github/actions/setup-kind-cluster
      with:
        cluster-name: ${{ matrix.test.cluster-name }}
        kind-node-version: ${{ steps.dotenv.outputs.node_version }}
        kubectl-version: ${{ steps.dotenv.outputs.kubectl_version }}
        istio-version: ${{ steps.dotenv.outputs.istio_version }}
        localstack: ${{ matrix.test.localstack }}
        agentgateway: ${{ matrix.test.agentgateway }}
        skip-docker: "true"
    - id: run-tests
      uses: ./.github/actions/kubernetes-e2e-tests
      with:
        cluster-name: ${{ matrix.test.cluster-name }}
        test-args: ${{ matrix.test.go-test-args }}
        run-regex: ${{ matrix.test.go-test-run-regex }}
        istio-version: ${{ steps.dotenv.outputs.istio_version }}
        matrix-label: "pr"
    - id: debug-space
      shell: bash
      run: |
        echo "After job disk space:"
        df -h
