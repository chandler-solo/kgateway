# This workflow blocks PRs from merging if they have certain labels.
name: Pre-merge label checker
on:
  pull_request:
    types: [opened, edited, reopened, synchronize, labeled, unlabeled]
  merge_group:
    types: [checks_requested]
  workflow_run:
    workflows:
      - Labeler
    types:
      - completed

concurrency:
  group: pr-kind-labeler-and-check-labels-mutex-${{ github.ref_name }}
  cancel-in-progress: false

concurrency:
  group: pr-kind-labeler-and-check-labels-mutex-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  check-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        if: github.event_name != 'merge_group'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref }}

      # only run this step on PRs, not in the merge queue (we need to explicitly add the merge queue logic because making this check required
      # causes it to get run in the merge queue as well)
      - name: Conditional skip for merge queue
        if: github.event_name == 'merge_group'
        run: |
          echo "Skipping check in merge queue"
          exit 0

      - name: Get PR number
        if: github.event_name != 'merge_group'
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            # For workflow_run events, find the PR from the head branch
            PR_NUMBER=$(gh pr list --head "${{ github.event.workflow_run.head_branch }}" --json number --jq '.[0].number')
          else
            # For pull_request events, use the event data
            PR_NUMBER="${{ github.event.pull_request.number }}"
          fi
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "PR number: $PR_NUMBER"

      - name: Check for labels that should block merge
        if: github.event_name != 'merge_group'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
        run: |
          # Fetch current labels from the API to avoid stale data from the event payload
          echo "Checking PR #$PR_NUMBER"
          CURRENT_LABELS=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name')

          echo "Current labels:"
          echo "$CURRENT_LABELS"

          echo "$CURRENT_LABELS" | while read -r label; do
            if [[ "$label" == "do-not-merge"* || "$label" == "work in progress" ]]; then
              echo "Pull request has 'do-not-merge' or 'work in progress' label. Blocking merge."
              exit 1
            fi
          done
