# This workflow blocks PRs from merging if they have certain labels.
name: Pre-merge label checker
on:
  pull_request:
    types: [opened, edited, reopened, synchronize, labeled, unlabeled]
  merge_group:
    types: [checks_requested]

concurrency:
  group: pr-kind-labeler-and-check-labels-mutex-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  check-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        if: github.event_name != 'merge_group'
        uses: actions/checkout@v4

      # only run this step on PRs, not in the merge queue (we need to explicitly add the merge queue logic because making this check required
      # causes it to get run in the merge queue as well)
      - name: Conditional skip for merge queue
        if: github.event_name == 'merge_group'
        run: |
          echo "Skipping check in merge queue"
          exit 0

      - name: Check for labels that should block merge
        if: github.event_name != 'merge_group'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Fetch current labels from the API to avoid stale data from the event payload
          echo "Checking PR #$PR_NUMBER"
          CURRENT_LABELS=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name')

          echo "Current labels:"
          echo "$CURRENT_LABELS"

          echo "$CURRENT_LABELS" | while read -r label; do
            if [[ "$label" == "do-not-merge"* || "$label" == "work in progress" ]]; then
              echo "Pull request has 'do-not-merge' or 'work in progress' label. Blocking merge."
              exit 1
            fi
          done
